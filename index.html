<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MedPair 藥品配對助手</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        theme0: { // Medical Blue
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7',
                        },
                        theme1: { // Nature Green
                            50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a',
                        },
                        theme2: { // History Purple
                            50: '#faf5ff', 100: '#f3e8ff', 500: '#a855f7', 600: '#9333ea',
                        },
                        theme3: { // Warm Orange
                            50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c',
                        },
                        theme4: { // Slate
                            50: '#f8fafc', 100: '#f1f5f9', 500: '#64748b', 600: '#475569',
                        },
                        accent: {
                            DEFAULT: '#F5A623', // Warm Sunrise
                            hover: '#d48806'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #f8fafc; 
            color: #334155; 
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Modal Transitions */
        .modal { transition: opacity 0.25s ease; pointer-events: none; opacity: 0; }
        .modal.active { pointer-events: auto; opacity: 1; }
        .modal-content { transition: transform 0.25s ease; transform: scale(0.95); }
        .modal.active .modal-content { transform: scale(1); }

        /* Custom Checkbox for Multi-select Dropdown */
        .multi-select-checkbox:checked + div {
            background-color: #f0f9ff;
            color: #0ea5e9;
        }
        
        /* Mobile Optimization */
        @media (max-width: 640px) {
            .modal-content { max-height: 95vh; }
            .hide-scrollbar-mobile::-webkit-scrollbar { display: none; }
            .hide-scrollbar-mobile { -ms-overflow-style: none; scrollbar-width: none; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 text-theme0-600 cursor-pointer" onclick="window.location.reload()">
                    <div class="bg-theme0-50 p-2 rounded-lg">
                        <i class="fa-solid fa-prescription-bottle-medical text-xl"></i>
                    </div>
                    <h1 class="font-bold text-lg sm:text-xl tracking-wide text-gray-800">MedPair <span class="text-xs text-gray-400 font-normal hidden sm:inline-block">藥品配對助手</span></h1>
                </div>
                <div class="flex items-center gap-2 sm:gap-3">
                    <button onclick="app.exportData()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-theme0-600 transition-colors relative group" title="匯出備份">
                        <i class="fa-solid fa-file-arrow-down text-lg"></i>
                    </button>
                    <label class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-theme0-600 transition-colors cursor-pointer relative group" title="匯入備份">
                        <i class="fa-solid fa-file-arrow-up text-lg"></i>
                        <input type="file" id="importFile" class="hidden" accept=".json" onchange="app.triggerImport(this)">
                    </label>
                    <div class="h-6 w-px bg-gray-200 mx-1"></div>
                    <button onclick="app.showSettings()" class="flex items-center gap-2 bg-gray-50 hover:bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full transition-colors border border-gray-200">
                        <i class="fa-solid fa-gear"></i>
                        <span class="text-sm font-medium hidden sm:inline">設定</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6">

        <!-- Expiry Alert (Conditional) -->
        <div id="expiryAlert" class="hidden bg-red-50 border border-red-100 rounded-xl p-4 shadow-sm animate-pulse">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-circle-exclamation text-red-500 text-xl mt-0.5"></i>
                </div>
                <div class="ml-3 w-full">
                    <h3 class="text-sm font-bold text-red-800">效期警告</h3>
                    <div class="mt-1 text-sm text-red-700 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1" id="expiryAlertContent">
                        <!-- Dynamic Content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Panel: Filter & Report (8 cols) -->
            <div class="lg:col-span-8 space-y-6 flex flex-col">
                
                <!-- Filter Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 z-20 relative">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-1.5 h-6 bg-theme0-500 rounded-full"></span>
                            報表與篩選
                        </h2>
                        <span class="text-xs bg-theme0-50 text-theme0-600 px-2 py-1 rounded-md border border-theme0-100">
                            系統日期: <span id="currentDateDisplay"></span>
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                         <!-- Multi-select Filter: Types -->
                         <div class="relative group" id="filterContainer_types">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">種類 (多選)</label>
                            <button onclick="app.toggleFilterDropdown('types')" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-2.5 text-sm text-left flex justify-between items-center focus:ring-2 focus:ring-theme0-500 focus:border-theme0-500">
                                <span class="truncate" id="filterLabel_types">全部種類</span>
                                <i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i>
                            </button>
                            <div id="filterDropdown_types" class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-100 shadow-xl rounded-xl p-2 z-50 max-h-60 overflow-y-auto custom-scrollbar">
                                <!-- Checkboxes injected here -->
                            </div>
                        </div>

                        <!-- Multi-select Filter: Indications -->
                        <div class="relative group" id="filterContainer_indications">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">適應症 (多選)</label>
                            <button onclick="app.toggleFilterDropdown('indications')" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-2.5 text-sm text-left flex justify-between items-center focus:ring-2 focus:ring-theme0-500 focus:border-theme0-500">
                                <span class="truncate" id="filterLabel_indications">全部功效</span>
                                <i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i>
                            </button>
                            <div id="filterDropdown_indications" class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-100 shadow-xl rounded-xl p-2 z-50 max-h-60 overflow-y-auto custom-scrollbar"></div>
                        </div>

                        <!-- Multi-select Filter: Shapes -->
                        <div class="relative group" id="filterContainer_shapes">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">樣貌 (多選)</label>
                            <button onclick="app.toggleFilterDropdown('shapes')" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-2.5 text-sm text-left flex justify-between items-center focus:ring-2 focus:ring-theme0-500 focus:border-theme0-500">
                                <span class="truncate" id="filterLabel_shapes">全部樣貌</span>
                                <i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i>
                            </button>
                            <div id="filterDropdown_shapes" class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-100 shadow-xl rounded-xl p-2 z-50 max-h-60 overflow-y-auto custom-scrollbar"></div>
                        </div>

                        <!-- Multi-select Filter: Users -->
                        <div class="relative group" id="filterContainer_users">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">使用者 (多選)</label>
                            <button onclick="app.toggleFilterDropdown('users')" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-2.5 text-sm text-left flex justify-between items-center focus:ring-2 focus:ring-theme0-500 focus:border-theme0-500">
                                <span class="truncate" id="filterLabel_users">全部使用者</span>
                                <i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i>
                            </button>
                            <div id="filterDropdown_users" class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-100 shadow-xl rounded-xl p-2 z-50 max-h-60 overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-between items-center gap-3 pt-4 border-t border-gray-100">
                        <button onclick="app.renderReport()" class="w-full sm:w-auto bg-theme0-600 text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-theme0-700 shadow-md transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-magnifying-glass"></i> 確認篩選
                        </button>
                    </div>
                </div>

                <!-- Report List -->
                <div class="flex-grow z-10">
                    <div class="flex justify-between items-end mb-3 px-1">
                        <h3 class="text-gray-700 font-bold text-base">符合條件項目</h3>
                        <span class="text-xs text-gray-500 font-mono bg-white px-2 py-1 rounded border" id="reportCount">0 筆</span>
                    </div>
                    <div id="reportList" class="space-y-3 pb-6">
                        <!-- Cards injected here -->
                    </div>
                </div>

                <!-- Create Combo Button -->
                <div class="sticky bottom-4 z-30">
                    <button onclick="app.prepareComboSave()" id="createComboBtn" class="w-full bg-accent text-white px-5 py-4 rounded-2xl text-base font-bold hover:bg-accent-hover shadow-lg shadow-orange-200/50 active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none border-2 border-white">
                        <i class="fa-solid fa-flask"></i> 建立配對組合 (<span id="selectedCount">0</span>)
                    </button>
                </div>
            </div>

            <!-- Right Panel: History (4 cols) -->
            <div class="lg:col-span-4">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 sticky top-24 max-h-[calc(100vh-8rem)] flex flex-col">
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                        <div class="flex items-center gap-2 flex-grow min-w-0">
                            <span class="w-1.5 h-6 bg-theme2-500 rounded-full flex-shrink-0"></span>
                            <h2 class="text-lg font-bold text-gray-800 flex-shrink-0 whitespace-nowrap">組合紀錄</h2>
                            
                            <!-- History Filter Dropdown -->
                            <div class="relative ml-2 w-auto min-w-[100px] flex-shrink">
                                <select id="historyFilterSelect" onchange="app.filterHistory(this.value)" class="w-full bg-theme2-50 border border-theme2-100 text-theme2-600 text-xs font-bold rounded-lg py-1.5 pl-2 pr-6 outline-none focus:ring-2 focus:ring-theme2-500 appearance-none truncate">
                                    <option value="">全部使用者</option>
                                    <!-- Options injected via JS -->
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-2 top-2 text-theme2-400 text-xs pointer-events-none"></i>
                            </div>
                        </div>
                        <button onclick="app.clearHistory()" class="text-xs text-gray-400 hover:text-red-500 underline ml-2 flex-shrink-0">清除</button>
                    </div>
                    
                    <div id="comboHistory" class="space-y-3 overflow-y-auto flex-grow pr-1 custom-scrollbar pb-10">
                        <!-- Combo items -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 sm:p-6">
        <div class="modal-content bg-white w-full max-w-5xl h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="flex justify-between items-center p-5 border-b bg-gray-50 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-2 rounded-lg shadow-sm border">
                        <i class="fa-solid fa-sliders text-theme0-600 text-lg"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">資料維護與設定</h2>
                </div>
                <button onclick="app.closeModal('settingsModal')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-500 transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b text-sm font-medium bg-white px-5 gap-6 overflow-x-auto flex-shrink-0">
                <button onclick="app.switchTab('tabMedicines')" class="tab-btn py-4 border-b-2 border-theme0-600 text-theme0-600 whitespace-nowrap" data-target="tabMedicines">
                    <i class="fa-solid fa-pills mr-1"></i> 庫存項目
                </button>
                <button onclick="app.switchTab('tabCats')" class="tab-btn py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-target="tabCats">
                    <i class="fa-solid fa-tags mr-1"></i> 分類清單
                </button>
                <button onclick="app.switchTab('tabUsers')" class="tab-btn py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-target="tabUsers">
                    <i class="fa-solid fa-users mr-1"></i> 使用者管理
                </button>
            </div>

            <!-- Content -->
            <div class="flex-grow overflow-y-auto bg-slate-50 p-4 sm:p-6 custom-scrollbar">
                
                <!-- Tab: Medicines -->
                <div id="tabMedicines" class="tab-content space-y-4">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm text-gray-500">管理您的藥品與保健食品庫存。</p>
                        <button onclick="app.deleteSelectedMedicines()" class="text-red-600 text-sm hover:bg-red-50 px-3 py-1.5 rounded-lg border border-transparent hover:border-red-100 transition-colors">
                            <i class="fa-solid fa-trash-can mr-1"></i> 刪除選取
                        </button>
                    </div>

                    <button onclick="app.openAddMedicineModal()" class="w-full py-4 border-2 border-dashed border-theme0-300 bg-theme0-50/50 hover:bg-theme0-50 text-theme0-600 rounded-xl font-bold transition-all flex items-center justify-center gap-2 mb-4 group">
                        <div class="bg-theme0-200 text-theme0-700 rounded-full w-6 h-6 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-plus text-xs"></i>
                        </div>
                        新增一筆項目
                    </button>

                    <div id="settingsMedicineList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Med Items JS Rendered -->
                    </div>
                </div>

                <!-- Tab: Categories -->
                <div id="tabCats" class="tab-content hidden space-y-6 max-w-3xl mx-auto">
                    <div id="categorySettingsContainer" class="space-y-4">
                        <!-- JS Rendered -->
                    </div>
                </div>

                <!-- Tab: Users -->
                <div id="tabUsers" class="tab-content hidden space-y-6 max-w-2xl mx-auto">
                    <div class="bg-white p-6 rounded-xl border shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-user-plus mr-2 text-theme0-500"></i> 新增使用者</h3>
                        <div class="flex gap-2">
                            <input type="text" id="newUserName" placeholder="輸入使用者姓名 (例如: 爺爺, 妹妹)" class="flex-1 border-gray-300 border p-2.5 rounded-lg focus:ring-2 focus:ring-theme0-500 outline-none">
                            <button onclick="app.addUser()" class="bg-theme0-600 text-white px-5 py-2.5 rounded-lg hover:bg-theme0-700 font-medium shadow-md">新增</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border shadow-sm overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b flex justify-between items-center">
                            <h4 class="font-bold text-gray-700 text-sm">現有使用者列表</h4>
                            <button onclick="app.deleteSelectedUsers()" class="text-red-500 text-xs hover:text-red-700 hover:underline">刪除選取項目</button>
                        </div>
                        <div id="settingsUserList" class="divide-y divide-gray-100"></div>
                    </div>
                    <p class="text-xs text-red-500 mt-2 bg-red-50 p-3 rounded border border-red-100">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                        注意：修改使用者名稱會同步更新歷史配對紀錄與藥品資料。刪除使用者則會移除相關紀錄。
                    </p>
                </div>

            </div>
        </div>
    </div>

    <!-- MED MODAL (Add/Edit) -->
    <div id="medModal" class="modal fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-3xl max-h-[90vh] rounded-xl shadow-2xl flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="font-bold text-lg text-gray-800" id="medModalTitle">新增項目</h3>
                <button onclick="app.closeModal('medModal')" class="w-8 h-8 rounded-full hover:bg-gray-200 text-gray-500 flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-5">
                <input type="hidden" id="medId">
                
                <!-- TYPE SELECTION (Dynamic) -->
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="medTypeSelection">
                    <!-- JS populated -->
                </div>

                <!-- Basic Info -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1.5" id="labelName">項目名稱 <span class="text-red-500">*</span></label>
                        <input type="text" id="medName" placeholder="例如: 普拿疼" class="w-full border-gray-300 border p-2.5 rounded-lg focus:ring-2 focus:ring-theme0-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1.5" id="labelSciName">學名 / 英文名</label>
                        <input type="text" id="medSciName" placeholder="例如: Acetaminophen" class="w-full border-gray-300 border p-2.5 rounded-lg focus:ring-2 focus:ring-theme0-500 bg-gray-50 outline-none">
                    </div>
                </div>

                <!-- Attributes -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1.5">外觀形狀</label>
                        <select id="medShape" class="w-full border-gray-300 border p-2.5 rounded-lg bg-white focus:ring-2 focus:ring-theme0-500 outline-none">
                            <!-- JS populated -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1.5">專屬適用者 (可多選)</label>
                        <div id="medUsersContainer" class="flex flex-wrap gap-2 border border-gray-200 p-2 rounded-lg bg-gray-50 min-h-[42px]">
                            <!-- Checkboxes -->
                        </div>
                    </div>
                </div>

                <!-- Tags Area -->
                <div class="space-y-4 border-t border-gray-100 pt-4">
                    <div>
                        <label class="block text-sm font-bold text-theme0-600 mb-2 transition-colors" id="labelIndication">適應症 / 功效 (可多選)</label>
                        <div id="medIndicationContainer" class="flex flex-wrap gap-2 border border-gray-200 p-2 rounded-lg bg-gray-50 min-h-[42px]">
                            <!-- Checkboxes -->
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-2 transition-colors" id="labelUsage">使用方法 (可多選)</label>
                        <div id="medUsageContainer" class="flex flex-wrap gap-2 border border-gray-200 p-2 rounded-lg bg-gray-50 min-h-[42px]">
                            <!-- Checkboxes -->
                        </div>
                    </div>
                    <!-- NEW: Dosage Field -->
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-2">使用劑量 (可多選)</label>
                        <div id="medDosageContainer" class="flex flex-wrap gap-2 border border-gray-200 p-2 rounded-lg bg-gray-50 min-h-[42px]">
                            <!-- Checkboxes -->
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-accent mb-2">注意事項 (可多選)</label>
                        <div id="medPrecautionContainer" class="flex flex-wrap gap-2 border border-gray-200 p-2 rounded-lg bg-gray-50 min-h-[42px]">
                            <!-- Checkboxes -->
                        </div>
                    </div>
                </div>

                <!-- Stock & Dates -->
                <div class="grid grid-cols-1 sm:grid-cols-12 gap-4 border-t border-gray-100 pt-4 bg-gray-50/50 p-3 rounded-lg">
                    <div class="sm:col-span-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">存量 <span class="text-red-500">*</span></label>
                        <div class="flex">
                            <input type="number" id="medStock" class="w-full border-gray-300 border p-2 rounded-l-lg focus:ring-2 focus:ring-theme0-500 outline-none" min="0" placeholder="0">
                            <input type="text" id="medUnit" class="w-20 border-gray-300 border-y border-r p-2 rounded-r-lg bg-white text-center text-sm" placeholder="單位">
                        </div>
                    </div>
                    <div class="sm:col-span-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">有效期限</label>
                        <input type="date" id="medExpiry" class="w-full border-gray-300 border p-2 rounded-lg focus:ring-2 focus:ring-theme0-500 outline-none">
                    </div>
                    <div class="sm:col-span-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">取得日期</label>
                        <input type="date" id="medAcquired" class="w-full border-gray-300 border p-2 rounded-lg focus:ring-2 focus:ring-theme0-500 outline-none text-gray-500">
                    </div>
                </div>

                <!-- Images Section -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 pt-2">
                    <!-- Field 1: Medicine Appearance -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">藥品外觀圖片 (報表顯示)</label>
                        <div class="flex items-start gap-4">
                            <div id="medImgPreview" class="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 border border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative group">
                                <span class="text-gray-400 text-xs">無圖片</span>
                            </div>
                            <div class="flex-grow">
                                <input type="file" id="medImgInput" accept="image/*" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-theme0-50 file:text-theme0-700 hover:file:bg-theme0-100 cursor-pointer" onchange="app.handleImageUpload(this, 'med')">
                                <p class="text-[10px] text-gray-400 mt-1">請上傳清晰的藥粒或包裝照。</p>
                                <button onclick="app.clearImage('med')" class="text-xs text-red-400 mt-1 hover:text-red-600 underline hidden" id="clearMedImgBtn">移除</button>
                            </div>
                        </div>
                    </div>

                    <!-- Field 2: Prescription -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">處方籤 / 說明書 (明細顯示)</label>
                        <div class="flex items-start gap-4">
                            <div id="presImgPreview" class="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 border border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative group">
                                <span class="text-gray-400 text-xs text-center px-1">無處方</span>
                            </div>
                            <div class="flex-grow">
                                <input type="file" id="presImgInput" accept="image/*" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-50 file:text-slate-700 hover:file:bg-slate-100 cursor-pointer" onchange="app.handleImageUpload(this, 'pres')">
                                <p class="text-[10px] text-gray-400 mt-1">可上傳醫生處方或藥袋說明。</p>
                                <button onclick="app.clearImage('pres')" class="text-xs text-red-400 mt-1 hover:text-red-600 underline hidden" id="clearPresImgBtn">移除</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3">
                <button onclick="app.closeModal('medModal')" class="px-5 py-2.5 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors font-medium">取消</button>
                <button onclick="app.saveMedicine()" class="px-6 py-2.5 bg-theme0-600 text-white font-bold rounded-lg hover:bg-theme0-700 shadow-md transition-all active:scale-95">儲存</button>
            </div>
        </div>
    </div>

    <!-- SAVE COMBO MODAL -->
    <div id="comboNameModal" class="modal fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl p-6 transform transition-all flex flex-col max-h-[90vh]">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-theme1-100 text-theme1-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-check text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800">建立組合</h3>
                <p class="text-sm text-gray-500">請設定組合名稱並選擇適用對象。</p>
            </div>
            
            <div class="flex-grow overflow-y-auto space-y-4 px-1 mb-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1.5">組合名稱</label>
                    <input type="text" id="comboNameInput" placeholder="例如: 早餐後服用、感冒備用藥" class="w-full border-gray-300 border p-3 rounded-xl focus:ring-2 focus:ring-theme0-500 outline-none text-center font-medium">
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1.5">適用使用者 (可多選)</label>
                    <div id="comboUserSelection" class="grid grid-cols-2 gap-2">
                        <!-- JS Rendered checkboxes -->
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 pt-4 border-t border-gray-100">
                <button onclick="app.closeModal('comboNameModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">取消</button>
                <button onclick="app.confirmSaveCombo()" class="px-4 py-2 bg-theme0-600 text-white rounded-lg hover:bg-theme0-700 font-bold shadow-md">確認儲存</button>
            </div>
        </div>
    </div>

    <!-- COMBO DETAIL MODAL -->
    <div id="comboDetailModal" class="modal fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-lg max-h-[80vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-5 border-b bg-gradient-to-r from-theme2-50 to-white">
                <h3 class="text-xl font-bold text-theme2-600" id="comboDetailTitle"></h3>
                <p class="text-xs text-gray-500 flex items-center gap-1 mt-1">
                    <i class="fa-regular fa-clock"></i>
                    <span id="comboDetailTime"></span>
                </p>
                <div class="mt-2 flex flex-wrap gap-1 text-xs" id="comboDetailUsers"></div>
            </div>
            <div class="p-5 overflow-y-auto space-y-4 custom-scrollbar bg-white" id="comboDetailContent">
                <!-- Details injected here -->
            </div>
            <div class="p-4 border-t bg-gray-50 text-center">
                <button onclick="app.closeModal('comboDetailModal')" class="w-full px-4 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">關閉視窗</button>
            </div>
        </div>
    </div>

    <!-- CONFIRM DIALOG -->
    <div id="confirmModal" class="modal fixed inset-0 z-[80] flex items-center justify-center bg-slate-900/40 p-4">
        <div class="modal-content bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full text-center">
            <div class="mb-4 w-14 h-14 bg-red-100 rounded-full flex items-center justify-center mx-auto text-red-500">
                <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
            </div>
            <h3 id="confirmTitle" class="text-lg font-bold text-gray-800 mb-2">確認</h3>
            <p id="confirmMsg" class="text-gray-600 mb-6 text-sm leading-relaxed"></p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="app.closeConfirm(false)" class="px-4 py-2.5 border border-gray-300 rounded-xl hover:bg-gray-50 text-gray-700 font-medium transition-colors">取消</button>
                <button onclick="app.closeConfirm(true)" class="px-4 py-2.5 bg-red-500 text-white rounded-xl hover:bg-red-600 shadow-md shadow-red-200 font-medium transition-colors">確認執行</button>
            </div>
        </div>
    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div id="imageModal" class="modal fixed inset-0 z-[90] flex items-center justify-center bg-black/90 p-4 backdrop-blur-sm" onclick="app.closeModal('imageModal')">
        <div class="relative max-w-4xl max-h-[90vh] w-full flex items-center justify-center">
            <button onclick="app.closeModal('imageModal')" class="absolute -top-10 right-0 text-white hover:text-gray-300 text-3xl">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <img id="fullImageView" src="" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-lg opacity-0 transition-all duration-300 pointer-events-none z-[100] text-sm flex items-center gap-3 translate-y-4">
        <i class="fa-solid fa-circle-check text-green-400 text-lg"></i>
        <span id="toastMsg" class="font-medium">操作成功</span>
    </div>

    <script>
        // --- UTILS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const max = 800;
                        if(w > max) { h = Math.round(h * max / w); w = max; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        };
        const isExpired = (dateStr) => dateStr && new Date(dateStr) < new Date();

        // Theme colors cycling
        const getTypeThemeName = (idx) => `theme${idx % 5}`;

        // --- APP LOGIC ---
        const app = {
            data: {
                medicines: [],
                users: [],
                combinations: [],
                settings: {
                    types: [],
                    indications: [],
                    usages: [],
                    dosages: [],
                    precautions: [],
                    shapes: []
                }
            },
            state: {
                tempImages: { med: null, pres: null },
                confirmCallback: null,
                historyFilterUid: null,
                activeCategory: 'types', // Default to types tab
                selectedMedIds: [],
                editMode: { key: null, item: null },
                filters: { // Multi-select filters state
                    types: [],
                    indications: [],
                    shapes: [],
                    users: []
                },
                activeDropdown: null
            },

            init() {
                this.loadData();
                this.ensureDefaults(); // Ensure default data exists
                document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('zh-TW');
                this.checkExpiry();
                this.renderHistory();
                this.populateFilters();
                this.renderReport(); // Initial load
                
                // Close dropdowns on outside click
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.relative.group')) {
                        this.closeAllDropdowns();
                    }
                });
            },

            // Ensure defaults logic
            ensureDefaults() {
                let changed = false;
                // Users
                if (!this.data.users || this.data.users.length === 0) {
                    this.data.users = [
                        { id: generateId(), name: '爸爸' },
                        { id: generateId(), name: '媽媽' },
                        { id: generateId(), name: '自己' }
                    ];
                    changed = true;
                }
                // Settings - Types
                if (!this.data.settings.types || this.data.settings.types.length === 0) {
                    this.data.settings.types = ['醫療藥品', '保健食品'];
                    changed = true;
                }
                // Settings - Indications
                if (!this.data.settings.indications || this.data.settings.indications.length < 3) {
                    this.data.settings.indications = ['感冒', '頭痛', '腸胃不適', '過敏', '外傷'];
                    changed = true;
                }
                // Settings - Usages
                if (!this.data.settings.usages || this.data.settings.usages.length < 3) {
                    this.data.settings.usages = ['飯後服用', '飯前服用', '睡前服用', '外用塗抹', '必要時使用'];
                    changed = true;
                }
                // Settings - Dosages
                if (!this.data.settings.dosages || this.data.settings.dosages.length < 3) {
                    this.data.settings.dosages = ['每次 1 顆', '每次 2 顆', '一天 3 次', '一天 1 次', '睡前服用'];
                    changed = true;
                }
                // Settings - Precautions
                if (!this.data.settings.precautions || this.data.settings.precautions.length < 3) {
                    this.data.settings.precautions = ['導致嗜睡', '多喝水', '不可飲酒', '孕婦不宜'];
                    changed = true;
                }
                // Settings - Shapes
                if (!this.data.settings.shapes || this.data.settings.shapes.length < 3) {
                    this.data.settings.shapes = ['膠囊', '圓形顆粒', '六角形', '膏狀', '藥包/粉狀', '液體/藥水'];
                    changed = true;
                }

                // DATA MIGRATION: Convert old 'med'/'supp' to new names if needed
                // Also ensure usage/dosage are arrays if they were strings
                this.data.medicines.forEach(m => {
                    if (m.type === 'med') { m.type = '醫療藥品'; changed = true; }
                    if (m.type === 'supp') { m.type = '保健食品'; changed = true; }
                    if (m.usage && !Array.isArray(m.usage)) { m.usage = [m.usage]; changed = true; }
                    if (m.dosage && !Array.isArray(m.dosage)) { m.dosage = [m.dosage]; changed = true; }
                });
                
                this.data.combinations.forEach(c => {
                    c.items.forEach(i => {
                        if (i.type === 'med') { i.type = '醫療藥品'; changed = true; }
                        if (i.type === 'supp') { i.type = '保健食品'; changed = true; }
                        if (i.usage && !Array.isArray(i.usage)) { i.usage = [i.usage]; changed = true; }
                        if (i.dosage && !Array.isArray(i.dosage)) { i.dosage = [i.dosage]; changed = true; }
                    });
                });

                if (changed) this.saveData();
            },

            // DATA MGMT
            saveData() {
                localStorage.setItem('medPairData_v2', JSON.stringify(this.data));
                this.checkExpiry();
                this.renderHistory(); 
                this.populateFilters(); // Refresh dropdowns
                this.renderReport();
            },

            loadData() {
                const stored = localStorage.getItem('medPairData_v2');
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        this.data = { ...this.data, ...parsed };
                        if(!this.data.settings) this.data.settings = {};
                    } catch(e) { console.error("Parse Error", e); }
                }
            },

            exportData() {
                const blob = new Blob([JSON.stringify(this.data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `MedPair_Backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                this.showToast('備份檔案下載中');
            },

            triggerImport(input) {
                if (!input.files || !input.files[0]) return;
                
                // Show confirm dialog
                this.confirm('匯入備份', '匯入將會完全覆蓋目前的資料，且無法復原。確定要繼續嗎？', () => {
                    const file = input.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const parsed = JSON.parse(e.target.result);
                            this.data = parsed;
                            this.ensureDefaults(); 
                            this.saveData();
                            this.init();
                            this.showToast('資料匯入成功');
                        } catch(err) { alert('匯入失敗：格式錯誤'); }
                        input.value = '';
                    };
                    reader.readAsText(file);
                });
            },

            // --- SETTINGS ---
            showSettings() {
                this.toggleModal('settingsModal', true);
                this.switchTab('tabMedicines');
            },

            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(tabId).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('border-theme0-600', 'text-theme0-600');
                    el.classList.add('border-transparent', 'text-gray-500');
                });
                const btn = document.querySelector(`button[data-target="${tabId}"]`);
                if(btn) {
                    btn.classList.remove('border-transparent', 'text-gray-500');
                    btn.classList.add('border-theme0-600', 'text-theme0-600');
                }

                if (tabId === 'tabMedicines') this.renderSettingsMedicines();
                if (tabId === 'tabCats') this.renderSettingsCats();
                if (tabId === 'tabUsers') this.renderSettingsUsers();
            },

            // 1. Medicines Settings
            renderSettingsMedicines() {
                const container = document.getElementById('settingsMedicineList');
                if (this.data.medicines.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">尚無資料</div>`;
                    return;
                }
                container.innerHTML = this.data.medicines.map(m => {
                    const typeIdx = this.data.settings.types.indexOf(m.type);
                    const theme = getTypeThemeName(typeIdx === -1 ? 0 : typeIdx);
                    // Dynamically set colors based on theme
                    const bgClass = `bg-${theme}-50 border-${theme}-200`;
                    const iconColor = `text-${theme}-500`;

                    return `
                    <div class="flex items-center p-4 border rounded-xl shadow-sm hover:shadow-md transition-shadow group relative overflow-hidden ${bgClass}">
                        <div class="flex items-center justify-center mr-3">
                             <input type="checkbox" class="med-delete-check w-5 h-5 text-red-600 rounded border-gray-300 focus:ring-red-500 cursor-pointer" value="${m.id}">
                        </div>
                        ${m.icon ? 
                            `<img src="${m.icon}" class="w-12 h-12 rounded-lg object-cover border border-gray-100 mr-3">` : 
                            `<div class="w-12 h-12 rounded-lg bg-white flex items-center justify-center mr-3 ${iconColor} border border-gray-100"><i class="fa-solid fa-pills"></i></div>`
                        }
                        <div class="flex-grow cursor-pointer" onclick="app.editMedicine('${m.id}')">
                            <div class="font-bold text-gray-800 flex items-center gap-2">
                                ${m.name}
                                ${m.prescription ? `<i class="fa-solid fa-file-medical text-gray-400 text-xs" title="已上傳處方籤"></i>` : ''}
                            </div>
                            <div class="text-xs text-gray-500 flex gap-2 mt-0.5">
                                <span class="bg-white border px-1.5 rounded">${m.stock} ${m.unit}</span>
                                <span class="text-${theme}-600 font-medium text-[10px] px-1.5 py-0.5 rounded border border-current">${m.type}</span>
                            </div>
                        </div>
                        <button onclick="app.editMedicine('${m.id}')" class="w-8 h-8 rounded-full bg-white text-gray-400 hover:text-theme0-600 border border-gray-200 flex items-center justify-center transition-all shadow-sm">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </div>
                `}).join('');
            },

            deleteSelectedMedicines() {
                const checks = document.querySelectorAll('.med-delete-check:checked');
                if (checks.length === 0) return;
                this.confirm('刪除確認', `確定要刪除這 ${checks.length} 項藥品嗎？無法復原。`, () => {
                    const ids = Array.from(checks).map(c => c.value);
                    this.data.medicines = this.data.medicines.filter(m => !ids.includes(m.id));
                    this.saveData();
                    this.renderSettingsMedicines();
                    this.showToast('藥品已刪除');
                });
            },

            // 2. Categories Settings
            renderSettingsCats() {
                const container = document.getElementById('categorySettingsContainer');
                const cats = [
                    { key: 'types', label: '種類', icon: 'fa-layer-group' },
                    { key: 'indications', label: '適應症 / 保健功效', icon: 'fa-tag' },
                    { key: 'usages', label: '使用方法', icon: 'fa-list-check' },
                    { key: 'dosages', label: '使用劑量', icon: 'fa-eye-dropper' },
                    { key: 'precautions', label: '注意事項', icon: 'fa-triangle-exclamation' },
                    { key: 'shapes', label: '樣貌', icon: 'fa-shapes' }
                ];

                container.innerHTML = cats.map(c => {
                    const isActive = this.state.activeCategory === c.key;
                    return `
                    <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden transition-all duration-300">
                        <button onclick="app.toggleCategory('${c.key}')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors text-left select-none">
                            <h4 class="font-bold text-gray-700 flex items-center gap-3">
                                <span class="w-8 h-8 rounded-full bg-white text-theme0-600 shadow-sm flex items-center justify-center border border-gray-100"><i class="fa-solid ${c.icon}"></i></span>
                                ${c.label}
                            </h4>
                            <i class="fa-solid fa-chevron-down text-gray-400 transition-transform ${isActive ? 'rotate-180' : ''}"></i>
                        </button>
                        <div class="${isActive ? 'block' : 'hidden'} p-4 bg-white border-t border-gray-100 animate-fade-in">
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="newCat_${c.key}" placeholder="新增項目..." class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-theme0-500">
                                <button onclick="app.addCategoryItem('${c.key}')" class="bg-theme0-500 text-white w-10 h-10 rounded-lg shadow-md hover:bg-theme0-600 transition-colors"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${(this.data.settings[c.key] || []).map(item => {
                                    const isEditing = this.state.editMode.key === c.key && this.state.editMode.item === item;
                                    
                                    if (isEditing) {
                                        return `
                                        <div class="inline-flex items-center gap-1 bg-white border border-theme0-300 rounded-full px-1.5 py-0.5 shadow-sm">
                                            <input type="text" id="editInput_${c.key}" value="${item}" class="text-sm text-gray-700 w-24 px-1 outline-none bg-transparent">
                                            <button onclick="app.saveCategoryEdit('${c.key}', '${item}')" class="text-green-500 hover:text-green-700 w-6 h-6 rounded-full hover:bg-green-50"><i class="fa-solid fa-check"></i></button>
                                            <button onclick="app.cancelEdit()" class="text-gray-400 hover:text-gray-600 w-6 h-6 rounded-full hover:bg-gray-100"><i class="fa-solid fa-xmark"></i></button>
                                        </div>`;
                                    } else {
                                        return `
                                        <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-50 text-gray-700 text-sm border border-gray-200 group">
                                            ${item}
                                            <button onclick="app.startEditCategory('${c.key}', '${item}')" class="text-gray-300 hover:text-theme0-600"><i class="fa-solid fa-pen text-xs"></i></button>
                                            <div class="h-3 w-px bg-gray-300"></div>
                                            <button onclick="app.deleteCategoryItem('${c.key}', '${item}')" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can text-xs"></i></button>
                                        </span>`;
                                    }
                                }).join('')}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },

            toggleCategory(key) {
                this.state.activeCategory = this.state.activeCategory === key ? null : key;
                this.state.editMode = { key: null, item: null };
                this.renderSettingsCats();
            },

            addCategoryItem(key) {
                const input = document.getElementById(`newCat_${key}`);
                const val = input.value.trim();
                if (!val) return;
                if (!this.data.settings[key]) this.data.settings[key] = [];
                if (this.data.settings[key].includes(val)) { this.showToast('項目已存在'); return; }
                
                this.data.settings[key].push(val);
                this.saveData();
                this.renderSettingsCats();
            },

            deleteCategoryItem(key, val) {
                if (confirm(`確定刪除「${val}」嗎？現有藥品中的此資料將保留，但無法再被選取。`)) {
                    this.data.settings[key] = this.data.settings[key].filter(i => i !== val);
                    this.saveData();
                    this.renderSettingsCats();
                }
            },

            startEditCategory(key, item) {
                this.state.editMode = { key, item };
                this.renderSettingsCats();
                setTimeout(() => document.getElementById(`editInput_${key}`)?.focus(), 50);
            },

            cancelEdit() {
                this.state.editMode = { key: null, item: null };
                this.renderSettingsCats();
                this.renderSettingsUsers();
            },

            saveCategoryEdit(key, oldVal) {
                const input = document.getElementById(`editInput_${key}`);
                const newVal = input.value.trim();
                if (!newVal || newVal === oldVal) { this.cancelEdit(); return; }
                
                const idx = this.data.settings[key].indexOf(oldVal);
                if (idx !== -1) this.data.settings[key][idx] = newVal;

                // Propagate changes to medicines
                const propMap = {
                    'types': 'type',
                    'indications': 'indication',
                    'usages': 'usage',
                    'dosages': 'dosage',
                    'precautions': 'precaution',
                    'shapes': 'shape'
                };
                const prop = propMap[key];

                if (prop) {
                    this.data.medicines.forEach(m => {
                        // Handle array properties
                        if (Array.isArray(m[prop])) {
                            m[prop] = m[prop].map(v => v === oldVal ? newVal : v);
                        } else if (m[prop] === oldVal) {
                            m[prop] = newVal;
                        }
                    });
                    this.data.combinations.forEach(c => {
                        c.items.forEach(item => {
                            if (Array.isArray(item[prop])) {
                                item[prop] = item[prop].map(v => v === oldVal ? newVal : v);
                            } else if (item[prop] === oldVal) {
                                item[prop] = newVal;
                            }
                        });
                    });
                }

                this.saveData(); // This calls renderReport() & populateFilters()
                this.cancelEdit();
                this.showToast('修改已同步');
            },

            // 3. User Settings
            renderSettingsUsers() {
                const container = document.getElementById('settingsUserList');
                container.innerHTML = this.data.users.map(u => {
                    const isEditing = this.state.editMode.key === 'user' && this.state.editMode.item === u.id;
                    
                    if (isEditing) {
                        return `
                        <div class="flex items-center justify-between p-4 bg-blue-50 border-b border-blue-100">
                            <div class="flex items-center gap-2 flex-grow">
                                <div class="w-8 h-8 rounded-full bg-white text-blue-600 flex items-center justify-center border">
                                    <i class="fa-solid fa-user-pen"></i>
                                </div>
                                <input type="text" id="editUserInput_${u.id}" value="${u.name}" class="flex-1 bg-white border border-blue-300 rounded px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                <button onclick="app.saveUserEdit('${u.id}', '${u.name}')" class="text-green-600 hover:bg-green-100 px-3 py-1.5 rounded text-sm font-bold">儲存</button>
                                <button onclick="app.cancelEdit()" class="text-gray-500 hover:bg-gray-200 px-3 py-1.5 rounded text-sm">取消</button>
                            </div>
                        </div>`;
                    } else {
                        return `
                        <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition-colors group border-b border-gray-50 last:border-0">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-theme0-100 text-theme0-600 flex items-center justify-center font-bold text-sm">
                                    ${u.name.charAt(0)}
                                </div>
                                <span class="font-medium text-gray-700">${u.name}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="app.startEditUser('${u.id}')" class="text-gray-400 hover:text-theme0-600 p-1 rounded-full hover:bg-theme0-50 transition-colors" title="修改名稱">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <input type="checkbox" class="user-delete-check w-5 h-5 text-red-600 rounded border-gray-300 focus:ring-red-500 cursor-pointer" value="${u.id}">
                            </div>
                        </div>`;
                    }
                }).join('');
            },

            addUser() {
                const input = document.getElementById('newUserName');
                const name = input.value.trim();
                if(!name) return;
                if(this.data.users.find(u => u.name === name)) {
                    this.showToast('使用者已存在'); return;
                }
                this.data.users.push({ id: generateId(), name });
                this.saveData();
                this.renderSettingsUsers();
                input.value = '';
                this.showToast('使用者已新增');
            },

            startEditUser(id) {
                this.state.editMode = { key: 'user', item: id };
                this.renderSettingsUsers();
                setTimeout(() => document.getElementById(`editUserInput_${id}`)?.focus(), 50);
            },

            saveUserEdit(id, oldName) {
                const input = document.getElementById(`editUserInput_${id}`);
                const newName = input.value.trim();
                if (!newName || newName === oldName) { this.cancelEdit(); return; }

                const user = this.data.users.find(u => u.id === id);
                if (user) user.name = newName;

                this.data.medicines.forEach(m => {
                    const idx = m.users.indexOf(oldName);
                    if (idx !== -1) m.users[idx] = newName;
                });

                this.data.combinations.forEach(c => {
                    const ownerIdx = c.users.indexOf(oldName);
                    if (ownerIdx !== -1) c.users[ownerIdx] = newName;
                });

                this.saveData();
                this.cancelEdit();
                this.showToast('使用者更名成功');
            },

            deleteSelectedUsers() {
                const checks = document.querySelectorAll('.user-delete-check:checked');
                if (checks.length === 0) return;
                this.confirm('刪除使用者', `刪除使用者將會同時移除所有相關的歷史紀錄。確定要刪除這 ${checks.length} 位使用者嗎？`, () => {
                    const ids = Array.from(checks).map(c => c.value);
                    const deletedNames = this.data.users.filter(u => ids.includes(u.id)).map(u => u.name);
                    
                    this.data.users = this.data.users.filter(u => !ids.includes(u.id));
                    this.data.combinations = this.data.combinations.filter(c => {
                         const hasDeletedUser = c.users.some(name => deletedNames.includes(name));
                         return !hasDeletedUser;
                    });
                    
                    this.saveData();
                    this.renderSettingsUsers();
                    this.showToast('使用者與相關紀錄已刪除');
                });
            },

            // --- MEDICINE FORM ---
            openAddMedicineModal() {
                this.resetForm();
                document.getElementById('medModalTitle').innerText = '新增項目';
                this.populateFormDropdowns();
                this.toggleModal('medModal', true);
            },

            editMedicine(id) {
                const item = this.data.medicines.find(m => m.id === id);
                if (!item) return;
                this.resetForm();
                document.getElementById('medModalTitle').innerText = '編輯項目';
                document.getElementById('medId').value = item.id;
                
                // Select type
                const typeRadio = document.querySelector(`input[name="itemType"][value="${item.type}"]`);
                if(typeRadio) typeRadio.checked = true;
                
                document.getElementById('medName').value = item.name;
                document.getElementById('medSciName').value = item.scientificName || '';
                document.getElementById('medShape').value = item.shape;
                // document.getElementById('medIndication').value = item.indication; // OLD
                // document.getElementById('medUsage').value = item.usage; // OLD
                // document.getElementById('medDosage').value = item.dosage || ''; // OLD
                // document.getElementById('medPrecaution').value = item.precaution; // OLD
                document.getElementById('medStock').value = item.stock;
                document.getElementById('medUnit').value = item.unit;
                document.getElementById('medExpiry').value = item.expiryDate || '';
                document.getElementById('medAcquired').value = item.acquiredDate || '';

                this.state.tempImages.med = item.icon;
                this.state.tempImages.pres = item.prescription;
                this.updateImagePreview('med', item.icon);
                this.updateImagePreview('pres', item.prescription);

                // Populate Checkboxes for Multi-Selects (Indication/Precaution)
                this.populateFormDropdowns(item);

                const userContainer = document.getElementById('medUsersContainer');
                userContainer.innerHTML = '';
                this.data.users.forEach(u => {
                    const checked = item.users && item.users.includes(u.name) ? 'checked' : '';
                    userContainer.innerHTML += `
                        <label class="inline-flex items-center cursor-pointer select-none">
                            <input type="checkbox" class="peer hidden" name="medUser" value="${u.name}" ${checked}>
                            <span class="px-2 py-1 rounded-md text-xs font-bold text-gray-400 bg-white border border-gray-200 peer-checked:bg-slate-600 peer-checked:text-white peer-checked:border-slate-600 transition-all">
                                ${u.name}
                            </span>
                        </label>
                    `;
                });
                
                this.toggleModal('medModal', true);
            },

            resetForm() {
                document.getElementById('medId').value = '';
                document.getElementById('medName').value = '';
                document.getElementById('medSciName').value = '';
                document.getElementById('medStock').value = '';
                document.getElementById('medUnit').value = '';
                // document.getElementById('medDosage').value = ''; // FIXED: Removed this line to prevent error
                document.getElementById('medExpiry').value = '';
                document.getElementById('medAcquired').value = '';
                document.getElementById('medImgInput').value = '';
                document.getElementById('presImgInput').value = '';
                
                this.state.tempImages = { med: null, pres: null };
                this.updateImagePreview('med', null);
                this.updateImagePreview('pres', null);
                
                // Populate types and select first
                const typeContainer = document.getElementById('medTypeSelection');
                typeContainer.innerHTML = this.data.settings.types.map((t, idx) => {
                    const theme = getTypeThemeName(idx);
                    const checked = idx === 0 ? 'checked' : '';
                    return `
                    <label class="flex-1 text-center cursor-pointer">
                        <input type="radio" name="itemType" value="${t}" class="peer hidden" ${checked}>
                        <div class="py-2 rounded-md text-sm font-bold text-gray-500 peer-checked:bg-white peer-checked:text-${theme}-600 peer-checked:shadow-sm transition-all border border-transparent peer-checked:border-gray-100">
                            ${t}
                        </div>
                    </label>`;
                }).join('');

                const userContainer = document.getElementById('medUsersContainer');
                userContainer.innerHTML = '';
                this.data.users.forEach(u => {
                    userContainer.innerHTML += `
                        <label class="inline-flex items-center cursor-pointer select-none">
                            <input type="checkbox" class="peer hidden" name="medUser" value="${u.name}">
                            <span class="px-2 py-1 rounded-md text-xs font-bold text-gray-400 bg-white border border-gray-200 peer-checked:bg-slate-600 peer-checked:text-white peer-checked:border-slate-600 transition-all">
                                ${u.name}
                            </span>
                        </label>
                    `;
                });
            },

            populateFormDropdowns(selectedItem = null) {
                // Populate Shapes (Single)
                const shapeEl = document.getElementById('medShape');
                shapeEl.innerHTML = '<option value="">請選擇...</option>';
                this.data.settings.shapes.forEach(val => {
                    const isSel = selectedItem?.shape === val ? 'selected' : '';
                    shapeEl.innerHTML += `<option value="${val}" ${isSel}>${val}</option>`;
                });

                // Helper for Multi-Select Checkboxes
                const renderCheckboxes = (containerId, items, nameAttr, selectedArr) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = items.map(val => {
                        // Handle legacy data (string) vs new array
                        let isChecked = false;
                        if (selectedArr) {
                            if (Array.isArray(selectedArr)) isChecked = selectedArr.includes(val);
                            else isChecked = selectedArr === val;
                        }
                        return `
                        <label class="inline-flex items-center cursor-pointer select-none">
                            <input type="checkbox" class="peer hidden" name="${nameAttr}" value="${val}" ${isChecked ? 'checked' : ''}>
                            <span class="px-2 py-1 rounded-md text-xs font-medium text-gray-500 bg-white border border-gray-200 peer-checked:bg-theme0-50 peer-checked:text-theme0-700 peer-checked:border-theme0-300 hover:bg-gray-50 transition-all">
                                ${val}
                            </span>
                        </label>`;
                    }).join('');
                };

                renderCheckboxes('medIndicationContainer', this.data.settings.indications, 'medIndication', selectedItem?.indication);
                renderCheckboxes('medUsageContainer', this.data.settings.usages, 'medUsage', selectedItem?.usage);
                renderCheckboxes('medDosageContainer', this.data.settings.dosages, 'medDosage', selectedItem?.dosage);
                renderCheckboxes('medPrecautionContainer', this.data.settings.precautions, 'medPrecaution', selectedItem?.precaution);
            },

            async handleImageUpload(input, type) {
                if (input.files && input.files[0]) {
                    const base64 = await compressImage(input.files[0]);
                    this.state.tempImages[type] = base64;
                    this.updateImagePreview(type, base64);
                }
            },

            updateImagePreview(type, src) {
                const previewEl = document.getElementById(type === 'med' ? 'medImgPreview' : 'presImgPreview');
                const clearBtn = document.getElementById(type === 'med' ? 'clearMedImgBtn' : 'clearPresImgBtn');
                
                if (src) {
                    previewEl.innerHTML = `<img src="${src}" class="w-full h-full object-cover cursor-zoom-in" onclick="app.viewImage('${src}')">`;
                    clearBtn.classList.remove('hidden');
                    previewEl.classList.remove('border-dashed');
                } else {
                    const txt = type === 'med' ? '無圖片' : '無處方';
                    previewEl.innerHTML = `<span class="text-gray-400 text-xs text-center px-1">${txt}</span>`;
                    clearBtn.classList.add('hidden');
                    previewEl.classList.add('border-dashed');
                }
            },

            clearImage(type) {
                this.state.tempImages[type] = null;
                document.getElementById(type === 'med' ? 'medImgInput' : 'presImgInput').value = '';
                this.updateImagePreview(type, null);
            },

            saveMedicine() {
                const id = document.getElementById('medId').value;
                const name = document.getElementById('medName').value.trim();
                const stock = document.getElementById('medStock').value;
                
                if (!name || !stock) {
                    this.showToast('請填寫名稱與存量');
                    return;
                }

                const userChecks = document.querySelectorAll('input[name="medUser"]:checked');
                const selectedUsers = Array.from(userChecks).map(c => c.value);
                const typeVal = document.querySelector('input[name="itemType"]:checked')?.value || this.data.settings.types[0];

                // Collect Multi-select values
                const indicationChecks = document.querySelectorAll('input[name="medIndication"]:checked');
                const selectedIndications = Array.from(indicationChecks).map(c => c.value);
                
                const usageChecks = document.querySelectorAll('input[name="medUsage"]:checked');
                const selectedUsages = Array.from(usageChecks).map(c => c.value);

                const dosageChecks = document.querySelectorAll('input[name="medDosage"]:checked');
                const selectedDosages = Array.from(dosageChecks).map(c => c.value);

                const precautionChecks = document.querySelectorAll('input[name="medPrecaution"]:checked');
                const selectedPrecautions = Array.from(precautionChecks).map(c => c.value);

                const newItem = {
                    id: id || generateId(),
                    type: typeVal,
                    name: name,
                    scientificName: document.getElementById('medSciName').value.trim(),
                    shape: document.getElementById('medShape').value,
                    indication: selectedIndications, // Store as Array
                    usage: selectedUsages, // Store as Array
                    dosage: selectedDosages, // Store as Array
                    precaution: selectedPrecautions, // Store as Array
                    stock: stock,
                    unit: document.getElementById('medUnit').value,
                    expiryDate: document.getElementById('medExpiry').value,
                    acquiredDate: document.getElementById('medAcquired').value,
                    icon: this.state.tempImages.med,
                    prescription: this.state.tempImages.pres,
                    users: selectedUsers,
                    updatedAt: new Date().toISOString()
                };

                // DEEP UPDATE: Update combinations history as well
                this.data.combinations.forEach(c => {
                    c.items.forEach(item => {
                        // Match by ID (preferred) or Name (legacy fallback)
                        if ((item.id && item.id === newItem.id) || (!item.id && item.name === newItem.name)) {
                            item.name = newItem.name;
                            item.type = newItem.type;
                            item.indication = newItem.indication;
                            item.usage = newItem.usage;
                            item.dosage = newItem.dosage;
                            item.icon = newItem.icon;
                            // Add id if it was missing
                            if(!item.id) item.id = newItem.id;
                        }
                    });
                });

                if (id) {
                    this.data.medicines = this.data.medicines.map(m => m.id === id ? newItem : m);
                    this.showToast('更新成功');
                } else {
                    this.data.medicines.push(newItem);
                    this.showToast('新增成功');
                }

                this.saveData();
                this.closeModal('medModal');
                this.renderReport();
                this.renderSettingsMedicines(); // Force refresh settings list
            },

            // --- REPORT & FILTER ---
            toggleFilterDropdown(key) {
                const el = document.getElementById(`filterDropdown_${key}`);
                const isHidden = el.classList.contains('hidden');
                this.closeAllDropdowns(); // Close others first
                if (isHidden) {
                    el.classList.remove('hidden');
                    this.state.activeDropdown = key;
                }
            },

            closeAllDropdowns() {
                ['types', 'indications', 'shapes', 'users'].forEach(key => {
                    document.getElementById(`filterDropdown_${key}`).classList.add('hidden');
                });
                this.state.activeDropdown = null;
            },

            populateFilters() {
                // Helper to build checkboxes
                const buildCheckboxes = (key, items, selectedArr) => {
                    const container = document.getElementById(`filterDropdown_${key}`);
                    if (!container) return;
                    container.innerHTML = items.map(item => {
                        const isChecked = selectedArr.includes(item) ? 'checked' : '';
                        return `
                        <label class="flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" value="${item}" ${isChecked} class="multi-select-checkbox w-4 h-4 text-theme0-600 rounded border-gray-300 focus:ring-theme0-500 mr-2" onchange="app.updateFilterState('${key}', this)">
                            <span class="text-sm text-gray-700">${item}</span>
                        </label>`;
                    }).join('');
                    this.updateFilterLabel(key);
                };

                buildCheckboxes('types', this.data.settings.types, this.state.filters.types);
                buildCheckboxes('indications', this.data.settings.indications, this.state.filters.indications);
                buildCheckboxes('shapes', this.data.settings.shapes, this.state.filters.shapes);
                buildCheckboxes('users', this.data.users.map(u=>u.name), this.state.filters.users);

                // History Filter Dropdown
                const histSelect = document.getElementById('historyFilterSelect');
                if (histSelect) {
                    histSelect.innerHTML = '<option value="">全部使用者</option>';
                    this.data.users.forEach(u => histSelect.innerHTML += `<option value="${u.name}">${u.name}</option>`);
                    if (this.state.historyFilterUid) histSelect.value = this.state.historyFilterUid;
                }
            },

            updateFilterState(key, checkbox) {
                const val = checkbox.value;
                if (checkbox.checked) {
                    if (!this.state.filters[key].includes(val)) this.state.filters[key].push(val);
                } else {
                    this.state.filters[key] = this.state.filters[key].filter(v => v !== val);
                }
                this.updateFilterLabel(key);
            },

            updateFilterLabel(key) {
                const count = this.state.filters[key].length;
                const labelEl = document.getElementById(`filterLabel_${key}`);
                const titles = { types: '全部種類', indications: '全部功效', shapes: '全部樣貌', users: '全部使用者' };
                
                if (count === 0) labelEl.innerText = titles[key];
                else labelEl.innerText = `已選 ${count} 項`;
                labelEl.classList.toggle('text-theme0-600', count > 0);
                labelEl.classList.toggle('font-bold', count > 0);
            },

            renderReport() {
                this.closeAllDropdowns(); // Close dropdowns on search

                let list = this.data.medicines.filter(m => {
                    const validDate = !m.expiryDate || new Date(m.expiryDate) >= new Date();
                    const hasStock = parseFloat(m.stock) > 0;
                    if (!validDate || !hasStock) return false;

                    const f = this.state.filters;
                    if (f.types.length > 0 && !f.types.includes(m.type)) return false;
                    
                    // Filter Indication (Multi-select Logic: If ANY selected filter matches ANY of med's indications)
                    if (f.indications.length > 0) {
                        const medInds = Array.isArray(m.indication) ? m.indication : [m.indication];
                        const match = medInds.some(i => f.indications.includes(i));
                        if (!match) return false;
                    }

                    if (f.shapes.length > 0 && !f.shapes.includes(m.shape)) return false;
                    if (f.users.length > 0 && !f.users.some(u => m.users.includes(u))) return false; // Match any
                    return true;
                });

                // Sort (Just sort by name now as indication is array)
                list.sort((a, b) => a.name.localeCompare(b.name));

                const container = document.getElementById('reportList');
                document.getElementById('reportCount').innerText = `${list.length} 筆`;
                this.state.selectedMedIds = [];
                this.updateComboBtn();

                if (list.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 border-2 border-dashed rounded-xl">沒有符合條件的項目</div>';
                    return;
                }

                container.innerHTML = list.map(m => {
                    const typeIdx = this.data.settings.types.indexOf(m.type);
                    const theme = getTypeThemeName(typeIdx === -1 ? 0 : typeIdx);
                    
                    const borderClass = `peer-checked:border-${theme}-500 peer-checked:bg-${theme}-50 border-${theme}-200`;
                    const iconColor = `text-${theme}-500`;
                    const tagBg = `bg-${theme}-50 text-${theme}-700`;
                    
                    // Format Array Display
                    const indText = Array.isArray(m.indication) ? m.indication.join('、') : m.indication;
                    const usageText = Array.isArray(m.usage) ? m.usage.join('、') : (m.usage || '-');
                    const dosageText = Array.isArray(m.dosage) ? m.dosage.join('、') : (m.dosage || '-');

                    return `
                    <label class="block relative group cursor-pointer select-none">
                        <input type="checkbox" class="checkbox-card peer hidden" onchange="app.toggleSelection('${m.id}')" value="${m.id}">
                        <div class="bg-white rounded-xl p-4 border shadow-sm hover:shadow-md transition-all flex gap-4 items-start relative overflow-hidden ${borderClass}">
                            
                            <!-- Image -->
                            <div class="w-20 h-20 rounded-lg bg-gray-50 flex-shrink-0 flex items-center justify-center overflow-hidden border border-gray-100">
                                ${m.icon ? 
                                    `<img src="${m.icon}" class="w-full h-full object-cover">` : 
                                    `<i class="fa-solid fa-pills ${iconColor} text-2xl"></i>`
                                }
                            </div>

                            <!-- Info -->
                            <div class="flex-grow min-w-0">
                                <div class="flex flex-col sm:flex-row justify-between items-start gap-2">
                                    <div class="flex items-center gap-2">
                                        <h3 class="font-bold text-lg text-gray-800">${m.name}</h3>
                                        ${m.prescription ? 
                                            `<button onclick="event.preventDefault(); app.viewImage('${m.prescription}')" class="text-accent hover:text-accent-hover font-bold text-sm underline decoration-accent/50 hover:decoration-accent transition-colors" title="處方籤">處方籤</button>` : ''
                                        }
                                    </div>
                                    <span class="text-xs ${tagBg} px-2 py-1 rounded-md font-medium flex-shrink-0">${indText || '未分類'}</span>
                                </div>
                                <p class="text-xs text-gray-400 mb-1">${m.scientificName || ''}</p>
                                
                                <div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-2 text-sm text-gray-600">
                                    <p class="truncate"><i class="fa-regular fa-clock w-4 text-center mr-1"></i> ${usageText}</p>
                                    <p class="truncate"><i class="fa-solid fa-eye-dropper w-4 text-center mr-1"></i> ${dosageText}</p>
                                    <p class="truncate"><i class="fa-solid fa-triangle-exclamation w-4 text-center mr-1"></i> ${Array.isArray(m.precaution) ? m.precaution.join('、') : (m.precaution || '-')}</p>
                                    <p class="truncate"><i class="fa-solid fa-user-group w-4 text-center mr-1"></i> 適用於: ${m.users.join(', ') || '無特定'}</p>
                                </div>
                            </div>
                        </div>
                    </label>
                `}).join('');
            },

            toggleSelection(id) {
                const idx = this.state.selectedMedIds.indexOf(id);
                if (idx > -1) this.state.selectedMedIds.splice(idx, 1);
                else this.state.selectedMedIds.push(id);
                this.updateComboBtn();
            },

            updateComboBtn() {
                const count = this.state.selectedMedIds.length;
                document.getElementById('selectedCount').innerText = count;
                const btn = document.getElementById('createComboBtn');
                if (count > 0) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            },

            prepareComboSave() {
                if (this.state.selectedMedIds.length === 0) return;
                document.getElementById('comboNameInput').value = '';
                
                const userContainer = document.getElementById('comboUserSelection');
                userContainer.innerHTML = '';
                if(this.data.users.length === 0) {
                    userContainer.innerHTML = '<span class="text-xs text-gray-400 col-span-2">請先至設定新增使用者</span>';
                } else {
                    this.data.users.forEach(u => {
                        userContainer.innerHTML += `
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer bg-white hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="comboUser" value="${u.name}" class="w-4 h-4 text-theme0-600 rounded border-gray-300 focus:ring-theme0-500 mr-2">
                                <span class="text-sm font-medium text-gray-700">${u.name}</span>
                            </label>
                        `;
                    });
                }

                this.toggleModal('comboNameModal', true);
            },

            confirmSaveCombo() {
                const name = document.getElementById('comboNameInput').value.trim();
                const userChecks = document.querySelectorAll('input[name="comboUser"]:checked');
                const selectedUsers = Array.from(userChecks).map(c => c.value);

                if (!name) { this.showToast('請輸入組合名稱'); return; }
                if (selectedUsers.length === 0) { this.showToast('請至少選擇一位適用使用者'); return; }

                const selectedItems = this.data.medicines.filter(m => this.state.selectedMedIds.includes(m.id));

                const combo = {
                    id: generateId(),
                    name: name,
                    date: new Date().toISOString(),
                    users: selectedUsers,
                    items: selectedItems.map(i => ({
                        id: i.id, // Store ID for deep updates
                        name: i.name,
                        indication: i.indication,
                        usage: i.usage,
                        dosage: i.dosage,
                        type: i.type,
                        icon: i.icon
                    }))
                };

                this.data.combinations.unshift(combo);
                this.saveData();
                this.closeModal('comboNameModal');
                
                this.state.selectedMedIds = [];
                document.querySelectorAll('.checkbox-card').forEach(c => c.checked = false);
                this.updateComboBtn();
                
                this.showToast('組合已儲存');
                this.renderHistory();
            },

            // --- HISTORY ---
            filterHistory(uname) {
                this.state.historyFilterUid = uname;
                this.renderHistory();
            },

            renderHistory() {
                const container = document.getElementById('comboHistory');
                let list = this.data.combinations;

                if (this.state.historyFilterUid) {
                    list = list.filter(c => c.users.includes(this.state.historyFilterUid));
                }
                
                list.sort((a,b) => new Date(b.date) - new Date(a.date));

                if (list.length === 0) {
                    container.innerHTML = `
                    <div class="text-center py-8 text-gray-400 border-2 border-dashed border-gray-100 rounded-xl">
                        <i class="fa-solid fa-clipboard-list text-3xl mb-2 opacity-30"></i>
                        <p class="text-sm">尚無組合紀錄</p>
                    </div>`;
                    return;
                }

                container.innerHTML = list.map(c => `
                    <div onclick="app.showComboDetail('${c.id}')" class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-all cursor-pointer group">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-bold text-gray-800 group-hover:text-theme2-600 transition-colors">${c.name}</h4>
                            <span class="text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded">${new Date(c.date).toLocaleDateString()}</span>
                        </div>
                        
                        <div class="text-xs text-gray-500 mb-2 flex items-center gap-1">
                            <i class="fa-solid fa-user-tag text-theme2-500"></i> 給: ${c.users.join('、')}
                        </div>

                        <div class="flex flex-wrap gap-1">
                            ${c.items.slice(0, 3).map(i => {
                                const typeIdx = this.data.settings.types.indexOf(i.type);
                                const theme = getTypeThemeName(typeIdx === -1 ? 0 : typeIdx);
                                const tagColor = `bg-${theme}-50 text-${theme}-700`;
                                return `<span class="text-[10px] ${tagColor} px-1.5 py-0.5 rounded">${i.name}</span>`;
                            }).join('')}
                            ${c.items.length > 3 ? `<span class="text-[10px] text-gray-400">+${c.items.length - 3}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            },

            showComboDetail(id) {
                const combo = this.data.combinations.find(c => c.id === id);
                if (!combo) return;

                document.getElementById('comboDetailTitle').innerText = combo.name;
                document.getElementById('comboDetailTime').innerText = new Date(combo.date).toLocaleString('zh-TW');
                
                const userContainer = document.getElementById('comboDetailUsers');
                userContainer.innerHTML = combo.users.map(u => 
                    `<span class="bg-theme2-50 text-theme2-600 px-2 py-1 rounded border border-theme2-100 flex items-center"><i class="fa-solid fa-user mr-1 text-[10px]"></i>${u}</span>`
                ).join('');

                const content = document.getElementById('comboDetailContent');
                content.innerHTML = combo.items.map(item => {
                    const typeIdx = this.data.settings.types.indexOf(item.type);
                    const theme = getTypeThemeName(typeIdx === -1 ? 0 : typeIdx);
                    const indColor = `text-${theme}-600 bg-${theme}-50`;
                    const iconColor = `text-${theme}-400`;
                    
                    const indText = Array.isArray(item.indication) ? item.indication.join('、') : item.indication;
                    const usageText = Array.isArray(item.usage) ? item.usage.join('、') : (item.usage || '-');
                    const dosageText = Array.isArray(item.dosage) ? item.dosage.join('、') : (item.dosage || '-');

                    return `
                    <div class="bg-white border border-gray-100 rounded-lg p-3 shadow-sm flex gap-3 items-start">
                        <div class="w-12 h-12 bg-gray-50 rounded-lg border border-gray-100 flex-shrink-0 overflow-hidden flex items-center justify-center">
                            ${item.icon ? 
                                `<img src="${item.icon}" class="w-full h-full object-cover">` : 
                                `<i class="fa-solid fa-pills ${iconColor}"></i>`
                            }
                        </div>
                        
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between font-bold text-gray-800 mb-1">
                                <span>${item.name}</span>
                                <span class="text-xs ${indColor} px-2 py-0.5 rounded">${indText}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs text-gray-500">
                                 <span class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${usageText}</span>
                                 ${dosageText ? `<span class="flex items-center gap-1"><i class="fa-solid fa-eye-dropper"></i> ${dosageText}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `}).join('');

                this.toggleModal('comboDetailModal', true);
            },

            clearHistory() {
                if (this.data.combinations.length === 0) return;
                this.confirm('清除紀錄', '確定要清空所有組合歷史紀錄嗎？無法復原。', () => {
                    this.data.combinations = [];
                    this.saveData();
                    this.showToast('紀錄已清空');
                });
            },

            // --- MISC ---
            checkExpiry() {
                const expired = this.data.medicines.filter(m => isExpired(m.expiryDate));
                const alertEl = document.getElementById('expiryAlert');
                const contentEl = document.getElementById('expiryAlertContent');
                
                if (expired.length > 0) {
                    alertEl.classList.remove('hidden');
                    contentEl.innerHTML = expired.map(m => `
                        <span>• ${m.name} (${m.expiryDate})</span>
                    `).join('');
                } else {
                    alertEl.classList.add('hidden');
                }
            },

            viewImage(src) {
                document.getElementById('fullImageView').src = src;
                this.toggleModal('imageModal', true);
            },

            toggleModal(id, show) {
                const el = document.getElementById(id);
                if (show) el.classList.add('active');
                else el.classList.remove('active');
            },
            closeModal(id) { this.toggleModal(id, false); },
            
            showToast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = msg;
                t.style.opacity = '1';
                t.style.transform = 'translate(-50%, 0)';
                setTimeout(() => {
                    t.style.opacity = '0';
                    t.style.transform = 'translate(-50%, 16px)';
                }, 2500);
            },

            confirm(title, msg, callback) {
                document.getElementById('confirmTitle').innerText = title;
                document.getElementById('confirmMsg').innerText = msg;
                this.state.confirmCallback = callback;
                this.toggleModal('confirmModal', true);
            },
            closeConfirm(isYes) {
                this.toggleModal('confirmModal', false);
                if (isYes && this.state.confirmCallback) this.state.confirmCallback();
                this.state.confirmCallback = null;
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>